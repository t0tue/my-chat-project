<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Google Î°úÍ∑∏Ïù∏</title>

    <style>
        
        body {
            height: 100vh; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            margin: 0; 
            font-family: Arial, sans-serif;
            background-color: #f0f0f0; 
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        #google-sign-in-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4285f4; 
            color: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.25);
            transition: background-color 0.3s;
        }

        #google-sign-in-button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>
    <h1>ÏõπÏÇ¨Ïù¥Ìä∏ Î°úÍ∑∏Ïù∏</h1>

    <button id="google-sign-in-button">
        Google Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏
    </button>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        
        const firebaseConfig = {
            apiKey: "AIzaSyByGjsbzMNtt5oP4-WQdP3GQYj17kCZZTg",
            authDomain: "web-chat-project-5add6.firebaseapp.com",
            projectId: "web-chat-project-5add6",
            storageBucket: "web-chat-project-5add6.firebasestorage.app",
            messagingSenderId: "717726064112",
            appId: "1:717726064112:web:041d2112ada17ef9359135",
            measurementId: "G-708GHVNSWG"
        };

        // üåü ReferenceError Ìï¥Í≤∞: CDNÏù¥ Î°úÎìúÎêú ÌõÑ firebase.initializeAppÏùÑ Ìò∏Ï∂úÌï©ÎãàÎã§.
        const app = firebase.initializeApp(firebaseConfig);
        
        // üåü authÏôÄ db Ïù∏Ïä§ÌÑ¥Ïä§Î•º Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ï†ïÏùòÌï©ÎãàÎã§.
        const auth = firebase.auth(app);
        const db = firebase.firestore(app);


        // ======= B. Î°úÍ∑∏Ïù∏ Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î°úÏßÅ (main.js ÎÇ¥Ïö©) =======

        /*ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º FirestoreÏùò 'users' Ïª¨Î†âÏÖòÏóê Ï†ÄÏû•ÌïòÍ±∞ÎÇò ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§.*/
        async function saveUserToFirestore(user) {
    
            const userRef = db.collection("users").doc(user.uid); 
            
            const userData = {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                lastLogin: new Date().toISOString(),
                createdAt: user.metadata.creationTime,
            };

            try {
                // merge: true ÏòµÏÖòÏúºÎ°ú Í∏∞Ï°¥ ÌïÑÎìúÎ•º Ïú†ÏßÄÌïòÎ©∞ ÏóÖÎç∞Ïù¥Ìä∏
                await userRef.set(userData, { merge: true }); 
                console.log("FirestoreÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû• ÏôÑÎ£å:", user.uid);
            } catch (e) {
                console.error("FirestoreÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù: ", e);
            }
        }

        //Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ ÌõÑ ÏßÄÏ†ïÎêú ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.
        function redirectToNextPage() {
            window.location.href = "chat_main.html"; 
        }

        // Google Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏ Î∞è ÌõÑÏÜç ÏûëÏóÖÏùÑ Ï≤òÎ¶¨Ìï©ÎãàÎã§.
        async function signInWithGoogleAndSave() {
            // GoogleAuthProviderÎäî firebase.auth.GoogleAuthProviderÎ•º ÌÜµÌï¥ Ï†ëÍ∑º
            const provider = new firebase.auth.GoogleAuthProvider(); 

            try {
                // signInWithPopupÏùÄ auth Ïù∏Ïä§ÌÑ¥Ïä§Î•º ÌÜµÌï¥ Ìò∏Ï∂ú
                const result = await auth.signInWithPopup(provider); 
                const user = result.user;
                console.log("Google Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ. ÏÇ¨Ïö©Ïûê:", user.displayName);

                await saveUserToFirestore(user);

                redirectToNextPage();

            } catch (error) {
                const errorCode = error.code;
                const errorMessage = error.message;

                if (errorCode !== 'auth/popup-closed-by-user') {
                   console.error("Google Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù:", errorCode, errorMessage);
                   alert(`Î°úÍ∑∏Ïù∏ Ïò§Î•ò: ${errorMessage}`);
                }
            }
        }

        // HTML Î¨∏ÏÑúÍ∞Ä ÏôÑÏ†ÑÌûà Î°úÎìúÎêú ÌõÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ïó∞Í≤∞
        document.addEventListener('DOMContentLoaded', () => {
            const signInButton = document.getElementById('google-sign-in-button');
            
            if (signInButton) {
                // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î°úÍ∑∏Ïù∏ Ìï®Ïàò Ïã§Ìñâ
                signInButton.addEventListener('click', signInWithGoogleAndSave);
            }
        });

    </script>
</body>
</html>